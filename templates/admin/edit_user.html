{% extends "admin/admin_base.html" %}

{% block title %}Edit User - Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>‚úèÔ∏è Edit User</h1>
        <p>Update user information and permissions</p>
    </div>
    
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h2>üë§ {{ user.get_full_name() }}</h2>
                <p>User ID: {{ user.id }} | Member since: {{ user.created_at.strftime('%B %d, %Y') }}</p>
            </div>
            
            <form method="POST" class="admin-form">
                {{ form.hidden_tag() }}
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.first_name.label(class="form-label") }}
                        {{ form.first_name(class="form-control") }}
                        {% if form.first_name.errors %}
                            <div class="form-errors">
                                {% for error in form.first_name.errors %}
                                    <span class="error">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.last_name.label(class="form-label") }}
                        {{ form.last_name(class="form-control") }}
                        {% if form.last_name.errors %}
                            <div class="form-errors">
                                {% for error in form.last_name.errors %}
                                    <span class="error">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control") }}
                    {% if form.email.errors %}
                        <div class="form-errors">
                            {% for error in form.email.errors %}
                                <span class="error">{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    {{ form.phone.label(class="form-label") }}
                    {{ form.phone(class="form-control") }}
                    {% if form.phone.errors %}
                        <div class="form-errors">
                            {% for error in form.phone.errors %}
                                <span class="error">{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <div class="checkbox-wrapper">
                            {{ form.is_admin(class="form-checkbox") }}
                            {{ form.is_admin.label(class="form-checkbox-label") }}
                        </div>
                        <small class="form-help">Admin users can access the admin panel and manage the system</small>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <div class="checkbox-wrapper">
                            {{ form.is_active(class="form-checkbox") }}
                            {{ form.is_active.label(class="form-checkbox-label") }}
                        </div>
                        <small class="form-help">Inactive users cannot log in to the system</small>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span>
                        Update User
                    </button>
                    <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">
                        <span class="btn-icon">‚Ü©Ô∏è</span>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
        
        
        <div class="info-card">
            <div class="card-header">
                <h3>üìä User Statistics</h3>
            </div>
            <div class="card-content">
                <div class="stat-item">
                    <span class="stat-label">Last Login:</span>
                    <span class="stat-value">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value">
                        {% if user.is_active %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-danger">Inactive</span>
                        {% endif %}
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Role:</span>
                    <span class="stat-value">
                        {% if user.is_admin %}
                            <span class="badge badge-warning">Admin</span>
                        {% else %}
                            <span class="badge badge-info">User</span>
                        {% endif %}
                    </span>
                </div>
                {% if not user.is_admin %}
                <div class="stat-item">
                    <span class="stat-label">Trial Status:</span>
                    <span class="stat-value">
                        {% set access_status = user.get_access_status() %}
                        {% if access_status.startswith("trial_") %}
                            {% set days_left = access_status.split("_")[1] %}
                            <span class="badge badge-success">Active - {{ days_left }} days left</span>
                        {% elif access_status.startswith("subscription_") %}
                            {% set days_left = access_status.split("_")[1] %}
                            <span class="badge badge-info">Subscription - {{ days_left }} days left</span>
                        {% else %}
                            <span class="badge badge-secondary">Limited Access</span>
                        {% endif %}
                    </span>
                </div>
                {% if user.trial_end %}
                <div class="stat-item">
                    <span class="stat-label">Trial End Date:</span>
                    <span class="stat-value">{{ user.trial_end.strftime('%Y-%m-%d') if user.trial_end else 'N/A' }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% if not user.is_admin %}
            <div class="card-actions" style="padding: 1rem; border-top: 1px solid #e9ecef;">
                <button onclick="resetMaterialViews({{ user.id }})" class="btn btn-warning" style="width: 100%;">
                    <span class="btn-icon">üîÑ</span>
                    Reset Material Views
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function resetMaterialViews(userId) {
    if (confirm('Are you sure you want to reset this user\'s material views? This will give them fresh first views on all materials.')) {
        fetch(`/admin/users/${userId}/reset-material-views`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Refresh the page to show updated status
            } else {
                alert('Failed to reset material views: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while resetting material views.');
        });
    }
}
</script>

<style>
.form-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
}

.form-card {
    background: white;
    border: 1px solid #000000;
    padding: 2rem;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.form-help {
    color: var(--text-secondary);
    font-size: 0.75rem;
    margin-left: 1.5rem;
}

.info-card {
    background: white;
    border: 1px solid #000000;
    height: fit-content;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-weight: bold;
    color: var(--text-primary);
}

.stat-value {
    color: var(--text-secondary);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0;
    font-size: 0.75rem;
    font-weight: bold;
    border: 1px solid #000000;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-danger {
    background: #dc3545;
    color: white;
}

.badge-warning {
    background: #ffc107;
    color: #000000;
}

.badge-info {
    background: #17a2b8;
    color: white;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

@media (max-width: 768px) {
    .form-container {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
